- name: Create a user for Loki
  become: true
  ansible.builtin.user:
    name: loki
    home: /home/loki
    create_home: yes
    group: admin

- name: Create directory for Loki
  become: true
  ansible.builtin.file:
    path: "/home/loki/loki"
    state: directory
    mode: '0755'

- name: Interpolate Loki configuration file
  become: true
  ansible.builtin.template:
    src: "loki-config.tpl"
    dest: '/home/loki/loki/loki-config.yaml'
    owner: loki
    mode: '0777'
  
- name: Interpolate docker-compose manifest
  become: true
  ansible.builtin.template:
    src: "docker-compose.tpl"
    dest: '/home/loki/loki/docker-compose.yaml'
    owner: loki
    mode: '0600'

- name: Pull down old Loki
  become: true
  community.docker.docker_compose_v2:
    project_src: /home/loki/loki
    state: absent

- name: Start new Loki
  become_user: loki
  community.docker.docker_compose_v2:
    project_src: /home/loki/loki
    wait: true
    wait_timeout: 180
  register: output

# BUG: This isn't currently working. Encounters some sort of error with the selectattr
# - name: Check if Loki container is running
#   become: true
#   ansible.builtin.assert:
#     that:
#       - (output.containers | selectattr("Name", "equalto", "loki") | first).State == 'running'
#     fail_msg: "Loki container is not running"


# - name: Check that Loki is running
#   ansible.builtin.assert:
#     that:
#       - loki_container.State == 'running'
#   vars:
#     loki_container: >-
#       {{ output.containers | selectattr("Service", "equalto", "loki") | first }}